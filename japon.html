<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Japon ‚Ä¢ Blog statique (HTML/CSS/JS) ‚Äì Lecture seule</title>
  <meta name="color-scheme" content="dark" />
  <style>
    /* ------------------------------
       Design System & Reset
    ------------------------------ */
    :root {
      --bg: #0a0a0a;
      --bg-elev: #151515;
      --card: #1b1b1b;
      --text: #f5f5f5;
      --muted: #b7b7b7;
      --accent: #ff5555;
      --accent-2: #ff8a65;
      --ring: #ffffff;
      --radius: 16px;
      --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.6);
      --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.45);
      --container: 1200px;
      --space: clamp(18px, 2.2vw, 28px);
      --section-pad: clamp(48px, 8vw, 90px);
      --card-w: clamp(200px, 42vw, 280px);
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); overflow-x: clip; line-height: 1.6; }
    img, picture, svg, video { display: block; max-width: 100%; }
    a { color: inherit; text-underline-offset: 2px; }
    button { font: inherit; color: inherit; }

    .section { padding: var(--section-pad) var(--space); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .wrap { max-width: var(--container); margin-inline: auto; }

    h2 {
      font-size: clamp(1.5rem, 1.1rem + 2vw, 2.4rem);
      margin: 0 0 22px;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      letter-spacing: .3px;
    }
    h2 .bar { inline-size: 10px; block-size: 28px; border-radius: 999px; background: linear-gradient(180deg, var(--accent), var(--accent-2)); box-shadow: 0 6px 18px rgba(255,85,85,.35); }

    p { color: var(--muted); }

    .scroll-card { display: grid; grid-auto-flow: column; grid-auto-columns: var(--card-w); gap: 18px; overflow-x: auto; padding: 6px 2px 14px; scroll-snap-type: x mandatory; scroll-padding-inline: var(--space); -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; }
    .scroll-card { scrollbar-width: none; }
    .scroll-card::-webkit-scrollbar { display: none; }

    .mini-card { position: relative; background: linear-gradient(180deg, var(--card), #111); border-radius: var(--radius); overflow: clip; scroll-snap-align: start; outline: none; border: 1px solid rgba(255,255,255,.06); box-shadow: var(--shadow-md); transition: transform .28s ease, box-shadow .28s ease, border-color .28s ease; cursor: pointer; contain: paint; }
    @media (hover: hover) and (pointer: fine) { .mini-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 20px 40px rgba(255,85,85,.25); border-color: rgba(255,85,85,.35); } }
    .mini-card:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,.15), 0 0 0 6px color-mix(in oklab, var(--accent) 70%, transparent); }
    .mini-card__img { width: 100%; aspect-ratio: 16 / 10; object-fit: cover; background: #0f0f0f; filter: saturate(1.05) contrast(1.02); transform: translateZ(0); }
    .mini-card__body { padding: 12px 14px 16px; }
    .mini-card__title { font-size: clamp(1rem, .9rem + .5vw, 1.15rem); margin: 6px 0 6px; letter-spacing: .2px; }
    .mini-card__text { margin: 0; font-size: .98rem; }

    .mini-card__day {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 6px 14px rgba(0,0,0,.35);
      font-size: .82rem;
      line-height: 1;
      backdrop-filter: blur(4px);
    }

    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px); opacity: 0; pointer-events: none; transition: opacity .35s ease; z-index: 999; }
    .backdrop.is-open { opacity: 1; pointer-events: auto; }

    .card-clone { position: fixed; z-index: 1000; inset: auto auto auto auto; border-radius: calc(var(--radius) + 4px); box-shadow: var(--shadow-lg); overflow: clip; transform-origin: center center; background: var(--bg-elev); border: 1px solid rgba(255,255,255,.08); }
    .clone-media { width: 100%; aspect-ratio: 16/10; object-fit: cover; background: #0f0f0f; }
    .clone-content { padding: clamp(16px, 2.2vw, 24px); max-height: 60svh; overflow: auto; }

    .close-btn { position: absolute; top: 10px; right: 10px; inline-size: 36px; block-size: 36px; border-radius: 999px; border: none; background: var(--accent); color: #fff; display: grid; place-items: center; box-shadow: 0 8px 20px rgba(255,85,85,.35); cursor: pointer; transition: transform .18s ease, opacity .18s ease, box-shadow .18s ease; }
    .close-btn:hover { transform: scale(1.04); }
    .close-btn:active { transform: scale(.98); }
    .close-btn:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,.2), 0 0 0 6px color-mix(in oklab, var(--accent) 70%, transparent); }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

    @media (max-width: 560px) { .clone-content { max-height: 55svh; } }
    @media (prefers-reduced-motion: reduce) { .mini-card, .backdrop, .card-clone, .close-btn { transition: none !important; } }

    /* Leaflet */
    #travel-map { height: clamp(420px, 62vh, 720px); width: 100%; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow-md); border: 1px solid rgba(255,255,255,.08); background: #0f0f0f; }
    .leaflet-control-zoom a { background: #222; color: #fff; border: 1px solid rgba(255,255,255,.1); }
    .leaflet-control-zoom a:hover { background: #2a2a2a; }
    .leaflet-control-attribution { background: rgba(0,0,0,.35); color: #ddd; }

    .panel { position: relative; margin-block: 14px 0 0; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .filters { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: center; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.14); background: #151515; font-size: .92rem; }
    .chip input { accent-color: #ff5555; }

    .emoji-pin { position: relative; display: grid; place-items: center; width: 38px; height: 38px; border-radius: 999px; background: radial-gradient(circle at 30% 30%, #2a2a2a, #141414); border: 2px solid rgba(255,255,255,.2); box-shadow: 0 6px 16px rgba(0,0,0,.5), 0 0 0 2px rgba(255,85,85,.15); font-size: 18px; }
    .emoji-pin::after { content: ""; position: absolute; bottom: -6px; width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 10px solid #1a1a1a; filter: drop-shadow(0 2px 2px rgba(0,0,0,.6)); }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<body>

  <div class="backdrop" id="backdrop" aria-hidden="true"></div>

  <!-- Bloc 1 : Carte interactive (lecture seule) -->
  <section id="map" class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Carte de mon voyage</h2>
      <div id="travel-map" role="region" aria-label="Carte interactive du Japon"></div>
      <div class="panel" aria-label="Filtres">
        <div class="filters" id="filters">
          <span class="chip"><input type="radio" name="mapcat" data-cat="city" checked> üèôÔ∏è Villes</span>
          <span class="chip"><input type="radio" name="mapcat" data-cat="monument"> üèõÔ∏è Monuments</span>
          <span class="chip"><input type="radio" name="mapcat" data-cat="activity"> üéå Activit√©s</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Bloc 2 : Villes visit√©es -->
  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Villes visit√©es</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Villes">
        <article class="mini-card" data-slug="jour-1-tokyo" data-day="Jour 1" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/tokyo.png" alt="Tokyo ‚Äì Shibuya" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Bloc 3 : Monuments vus -->
  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Monuments vus</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Monuments">
        <article class="mini-card" data-slug="jour-3-fushimi-inari" data-day="Jour 1" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/fushimi.jpg" alt="Fushimi Inari" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Bloc 4 : Activit√©s faites -->
  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Activit√©s faites</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Activit√©s">
        <article class="mini-card" data-slug="jour-4-ceremonie-the" data-day="Jour 1" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/ceremonie.jpg" alt="C√©r√©monie du th√©" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Bloc 5 : Ressenti / √âmotion -->
  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Ressenti / √âmotion</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Ressenti">
        <article class="mini-card" data-slug="jour-5-choc-culturel" data-day="Jour 1" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/ressenti.jpg" alt="Rue calme" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Bloc 6 : Edit -->
  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Edit</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì √âdits vid√©o">
        <article class="mini-card" data-slug="jour-6-marche-tokyo" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/marche.jpg" alt="Marche" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Bloc 8 : Livre lu -->
  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Livre lu</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Livres">
        <article class="mini-card" data-slug="jour-7-mishima" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/mishima.jpg" alt="Livre" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ===== Fly Card (lecture seule) =====
    const FOCUSABLE = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
    const backdrop = document.getElementById('backdrop');
    let openClone = null, originRect = null, lastFocusedEl = null;

    document.addEventListener('click', (e) => {
      const card = e.target.closest('.mini-card');
      if (!card) return;
      e.preventDefault();
      flyCard(card);
    });
    document.addEventListener('keydown', (e) => {
      const card = e.target.closest?.('.mini-card');
      if (card && (e.key === 'Enter' || e.key === ' ')) { e.preventDefault(); flyCard(card); }
      if (e.key === 'Escape' && openClone) closeFly();
    });

    // Injecte un badge "Jour X" directement sur chaque mini-card
    (function attachDayBadges(){
      document.querySelectorAll('.mini-card').forEach(card => {
        const day = card.dataset.day;
        if (!day) return;
        if (card.querySelector('.mini-card__day')) return; // √©vite doublons
        const badge = document.createElement('div');
        badge.className = 'mini-card__day';
        badge.textContent = day;
        card.appendChild(badge);
      });
    })();
    backdrop.addEventListener('click', () => { if (openClone) closeFly(); });

    function flyCard(card){
      if (openClone) return;
      lastFocusedEl = document.activeElement;
      originRect = card.getBoundingClientRect();

      const clone = document.createElement('div');
      clone.className = 'card-clone';
      setRect(clone.style, originRect);

      const media = card.querySelector('img').cloneNode();
      media.className = 'clone-media';
      media.removeAttribute('loading');

      const content = document.createElement('div');
      content.className = 'clone-content';
      const title = document.createElement('h3');
      title.textContent = "Rien √† l'heure actuelle";
      const dayLine = document.createElement('div');
      const day = card.dataset.day;
      if (day) {
        dayLine.textContent = day;
        dayLine.style.fontSize = '.9rem';
        dayLine.style.opacity = '.85';
        dayLine.style.marginTop = '-2px';
        dayLine.style.marginBottom = '8px';
      }
      const text = document.createElement('p');
      text.textContent = "Rien √† l'heure actuelle";
      text.style.color = 'var(--muted)';
      content.append(title, day ? dayLine : null, text);

      const close = document.createElement('button');
      close.className = 'close-btn';
      close.type = 'button';
      close.setAttribute('aria-label','Fermer la carte');
      close.innerHTML = '<span aria-hidden="true">‚úï</span><span class="sr-only">Fermer</span>';
      close.addEventListener('click', closeFly);

      clone.append(media, close, content);
      document.body.appendChild(clone);

      requestAnimationFrame(() => {
        const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        backdrop.classList.add('is-open');
        backdrop.setAttribute('aria-hidden','false');
        document.documentElement.style.overflow = 'hidden';
        const target = targetRect();
        if (!reduced) clone.style.transition = 'all 450ms cubic-bezier(.2,.7,.2,1)';
        applyRect(clone.style, target);
        clone.style.transform = 'translate(-50%, -50%)';
        setTimeout(() => (clone.querySelector(FOCUSABLE) || close).focus({preventScroll:true}), reduced?0:220);
      });
      openClone = clone;
      document.addEventListener('focus', trapFocus, true);
    }
    function closeFly(){
      if (!openClone) return;
      const clone = openClone; const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!reduced) clone.style.transition = 'all 420ms cubic-bezier(.2,.7,.2,1)';
      setRect(clone.style, originRect); clone.style.transform = 'translate(0,0)';
      backdrop.classList.remove('is-open'); backdrop.setAttribute('aria-hidden','true');
      setTimeout(()=>{ clone.remove(); openClone=null; document.documentElement.style.overflow=''; document.removeEventListener('focus', trapFocus, true); if (lastFocusedEl?.focus) lastFocusedEl.focus({preventScroll:true}); }, reduced?0:420);
    }
    function trapFocus(e){ if (openClone && !openClone.contains(e.target)){ e.stopPropagation(); (openClone.querySelector(FOCUSABLE)||openClone).focus(); } }
    function setRect(s, r){ s.top=r.top+'px'; s.left=r.left+'px'; s.width=r.width+'px'; s.height=r.height+'px'; }
    function applyRect(s, r){ s.top=r.top; s.left=r.left; s.width=r.width; s.height=r.height; }
    function targetRect(){ const w=Math.min(900, innerWidth*0.9), h=Math.min(900, innerHeight*0.85); return { top:'50%', left:'50%', width:w+'px', height:h+'px' }; }

  // ===== Leaflet (lecture seule) ‚Äî version FR, ordre garanti =====
  // 1) Cr√©e la carte d'abord
  const map = L.map('travel-map', {
    zoomControl: false,
    scrollWheelZoom: true,
    worldCopyJump: true,
    attributionControl: true
  }).setView([36.2048, 138.2529], 5);

  // 2) Tuiles OSM France (libell√©s FR)
  L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
    maxZoom: 20,
    subdomains: 'abc',
    attribution: 'Donn√©es cartographiques ¬© contributeurs OpenStreetMap | Tuiles : OpenStreetMap France'
  }).addTo(map);

  // 3) Contr√¥les FR
  L.control.zoom({ position: 'topleft', zoomInTitle: 'Zoomer', zoomOutTitle: 'D√©zoomer' }).addTo(map);
  L.control.scale({ metric: true, imperial: false, maxWidth: 200 }).addTo(map);

  // 4) Panne 'emoji' au-dessus des overlays (s√©curit√© visibilit√©)
  //    (par d√©faut markerPane zIndex=600 ; on monte √† 650)
  const emojiPane = map.createPane('emojiPane');
  emojiPane.style.zIndex = 650;

  // 5) Cat√©gories + calques
  const CATS = {
    city:     { label: 'Villes',    emoji: 'üèôÔ∏è' },
    monument: { label: 'Monuments', emoji: 'üèõÔ∏è' },
    activity: { label: 'Activit√©s', emoji: 'üéå' },
    feeling:  { label: 'Ressenti',  emoji: 'üí≠' },
    book:     { label: 'Livres',    emoji: 'üìö' }
  };
  const VISIBLE_CATS = ['city','monument','activity'];
  const categoryLayers = Object.fromEntries(VISIBLE_CATS.map(k => [k, L.layerGroup().addTo(map)]));

  // 6) Ic√¥ne emoji (dans notre pane d√©di√©)
  function emojiIcon(emoji='üìç'){
    return L.divIcon({
      className: 'emoji-icon',
      html: `<div class="emoji-pin" aria-hidden="true">${emoji}</div>`,
      iconSize: [38, 44],
      iconAnchor: [19, 40],
      popupAnchor: [0, -32]
    });
  }

  // 7) Liaison pin -> card
  function openCardBySlug(slug) {
    if (!slug) return;
    const card = document.querySelector(`.mini-card[data-slug="${slug}"]`);
    if (!card) return;
    const scroller = card.closest('.scroll-card');
    if (scroller) card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    else card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => flyCard(card), 250);
  }

  // 8) Chargement markers.json
  fetch('./markers.json', { cache: 'no-cache' })
    .then(r => { console.log('[markers] HTTP', r.status); if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
    .then(json => { console.log('[markers] payload', json); loadFrom(json); })
    .catch(err => {
      console.error('[markers] √©chec :', err);
      // Seed test si fetch √©choue
      loadFrom({ items: [{ lat:35.6595, lng:139.7005, category:'city', emoji:'üèôÔ∏è', day:'Jour 1', title:'Tokyo (seed)', desc:"Rien √† l'heure actuelle", slug:'jour-1-tokyo' }] });
    });

  function loadFrom(json){
    const items = (json && Array.isArray(json.items)) ? json.items : [];
    console.log(`[markers] ${items.length} items`);
    items.forEach((it, i) => {
      if (typeof it.lat !== 'number' || typeof it.lng !== 'number') {
        console.warn('[markers] item ignor√© (lat/lng invalides):', it);
        return;
      }
      const rawCat = it.category || 'city';
      const cat = (rawCat === 'temple') ? 'monument' : rawCat;
      const marker = L.marker([it.lat, it.lng], {
        icon: emojiIcon(it.emoji || (CATS[cat]?.emoji) || 'üìç'),
        pane: 'emojiPane' // force le rendu au-dessus
      });

      const popup = renderPopup(it, cat);
      marker.bindPopup(popup, { closeButton: true });
      if (categoryLayers[cat]) {
        categoryLayers[cat].addLayer(marker);
      }

      console.log(`[markers] OK -> #${i+1}`, it.title || '(sans titre)');
    });
    if (items.length) fitToMarkers();
  }

  function renderPopup(it, cat){
    const wrap = document.createElement('div');
    const t = (it.title || "Rien √† l'heure actuelle");
    const d = (it.desc  || "Rien √† l'heure actuelle");
    const slug = it.slug;

    wrap.innerHTML = `
      <strong style="display:block;margin-bottom:4px">${(it.emoji||'üìç')} ${escapeHtml(t)}</strong>
      ${it.day ? `<div style="color:#bbb;">${escapeHtml(it.day)}</div>` : ''}
      <div style="color:#ccc;white-space:pre-wrap">${escapeHtml(d)}</div>
      <div style="margin-top:8px;font-size:.85rem;color:#bbb">Cat√©gorie : ${CATS[it.category]?.emoji || ''} ${CATS[it.category]?.label || it.category || cat}</div>
      ${slug ? `<div style="margin-top:10px"><button type="button" class="goto-card" style="border:1px solid rgba(255,255,255,.14);background:#222;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer">Voir la carte ‚Üí</button></div>` : ''}
    `;

    if (slug) {
      wrap.querySelector('.goto-card').addEventListener('click', () => {
        map.closePopup();
        openCardBySlug(slug);
      });
    }
    return wrap;
  }

  function escapeHtml(str=''){ return str.replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[s])); }
  function fitToMarkers(){ const b=L.latLngBounds([]); for (const g of Object.values(categoryLayers)) g.eachLayer(m=>{ if(m.getLatLng) b.extend(m.getLatLng()); }); if (b.isValid()) map.fitBounds(b.pad(0.2)); }

  // 9) Filtres lecture seule (restent inchang√©s)
  document.querySelectorAll('#filters input[type="checkbox"]').forEach(cb => {
    const cat = cb.dataset.cat; const group = categoryLayers[cat];
    cb.addEventListener('change', () => { cb.checked ? map.addLayer(group) : map.removeLayer(group); });
  });

  // (le reste de ton code map : CATS, categoryLayers, emojiIcon, fetch/loadFrom, renderPopup, etc.)

    // --- Helpers pour lier pin -> card ---
    function openCardBySlug(slug) {
      if (!slug) return;
      const card = document.querySelector(`.mini-card[data-slug="${slug}"]`);
      if (!card) return;
      // scroll jusqu‚Äô√† la card (dans le scroller horizontal si pr√©sent)
      const scroller = card.closest('.scroll-card');
      if (scroller) {
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      } else {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      // ouvre la fly-card apr√®s un court d√©lai
      setTimeout(() => flyCard(card), 250);
    }

    // --- Charge markers.json ---
    fetch('./markers.json', { cache: 'no-cache' })
      .then(r => {
        console.log('[markers] HTTP status =', r.status, r.url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      })
      .then(json => {
        console.log('[markers] payload =', json);
        loadFrom(json);
      })
      .catch(err => {
        console.error('[markers] √©chec de chargement :', err);
        // Seed de secours si fetch √©choue (pour test)
        loadFrom({
          items: [{
            lat: 35.6595, lng: 139.7005,
            category: 'city', emoji: 'üèôÔ∏è',
            title: "Tokyo (seed)", desc: "Rien √† l'heure actuelle", slug: "jour-1-tokyo"
          }]
        });
      });

    function loadFrom(json){
      const items = (json && Array.isArray(json.items)) ? json.items : [];
      console.log(`[markers] ${items.length} items`);
      items.forEach((it, i) => {
        if (typeof it.lat !== 'number' || typeof it.lng !== 'number') {
          console.warn('[markers] item ignor√© (lat/lng invalides):', it);
          return;
        }
        const rawCat = it.category || 'city';
        const cat = (rawCat === 'temple') ? 'monument' : rawCat;
        const m = L.marker([it.lat, it.lng], {
          icon: emojiIcon(it.emoji || (CATS[cat]?.emoji) || 'üìç')
        });

        // Popup avec bouton pour ouvrir la card li√©e
        const popup = renderPopup(it, cat);
        m.bindPopup(popup, { closeButton: true });

        if (categoryLayers[cat]) {
          categoryLayers[cat].addLayer(m);
        }
        console.log(`[markers] OK -> #${i+1}`, it.title || '(sans titre)');
      });
      if (items.length) fitToMarkers();
    }

    function renderPopup(it, cat){
      const wrap = document.createElement('div');
      const t = (it.title || "Rien √† l'heure actuelle");
      const d = (it.desc  || "Rien √† l'heure actuelle");
      const slug = it.slug;

      wrap.innerHTML = `
        <strong style="display:block;margin-bottom:4px">${(it.emoji||'üìç')} ${escapeHtml(t)}</strong>
        ${it.day ? `<div style="color:#bbb;">${escapeHtml(it.day)}</div>` : ''}
        <div style="color:#ccc;white-space:pre-wrap">${escapeHtml(d)}</div>
        <div style="margin-top:8px;font-size:.85rem;color:#bbb">Cat√©gorie : ${CATS[it.category]?.emoji || ''} ${CATS[it.category]?.label || it.category || cat}</div>
        ${slug ? `<div style="margin-top:10px"><button type="button" class="goto-card" style="border:1px solid rgba(255,255,255,.14);background:#222;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer">Voir la carte ‚Üí</button></div>` : ''}
      `;

      if (slug) {
        wrap.querySelector('.goto-card').addEventListener('click', () => {
          map.closePopup();
          openCardBySlug(slug);
        });
      }
      return wrap;
    }

    function escapeHtml(str=''){ return str.replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[s])); }
    function fitToMarkers(){ const b=L.latLngBounds([]); for (const g of Object.values(categoryLayers)) g.eachLayer(m=>{ if(m.getLatLng) b.extend(m.getLatLng()); }); if (b.isValid()) map.fitBounds(b.pad(0.2)); }

    // Filtres lecture seule (radios)
    document.querySelectorAll('#filters input[type="radio"]').forEach(rb => {
      const cat = rb.dataset.cat;
      rb.addEventListener('change', () => {
        if (!rb.checked) return;
        // retire tous les calques
        Object.values(categoryLayers).forEach(g => { try { map.removeLayer(g); } catch(e){} });
        // ajoute le calque choisi
        const group = categoryLayers[cat];
        if (group) map.addLayer(group);
      });
    });

    // Appliquer l'√©tat initial (radio s√©lectionn√©)
    (function(){
      const selected = document.querySelector('#filters input[type="radio"]:checked');
      if (!selected) return;
      Object.values(categoryLayers).forEach(g => { try { map.removeLayer(g); } catch(e){} });
      const group = categoryLayers[selected.dataset.cat];
      if (group) map.addLayer(group);
    })();

    // -- Aligner l'ordre des boutons sur les cards (Villes, Monuments, Activit√©s)
    (function(){
      const desiredOrder = ['city','monument','activity'];
      const container = document.getElementById('filters');
      if (!container) return;
      const pairs = Array.from(container.querySelectorAll('.chip'))
        .map(ch => [ch.querySelector('input')?.dataset.cat, ch]);
      const byCat = new Map(pairs);
      desiredOrder.forEach(cat => { const chip = byCat.get(cat); if (chip) container.appendChild(chip); });
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Mon voyage au Japon</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0a0a0a; --bg-elev:#151515; --card:#1b1b1b; --text:#f5f5f5; --muted:#b7b7b7;
      --accent:#ff5555; --accent-2:#ff8a65; --ring:#ffffff;
      --radius:16px; --shadow-lg:0 20px 50px rgba(0,0,0,.6);
      --shadow-md:0 10px 30px rgba(0,0,0,.45);
      --container:1200px; --space:clamp(18px,2.2vw,28px);
      --section-pad:clamp(48px,8vw,90px); --card-w:clamp(200px,42vw,280px);
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text);overflow-x:clip;line-height:1.6}
    img,svg,video{display:block;max-width:100%}
    a{color:inherit;text-underline-offset:2px}
    html{scroll-behavior:smooth}
    ::selection{background:color-mix(in oklab, var(--accent) 55%, transparent);color:#fff}

    .section{padding:var(--section-pad) var(--space);border-bottom:1px solid rgba(255,255,255,.08)}
    .wrap{max-width:var(--container);margin-inline:auto}
    h2{font-size:clamp(1.5rem,1.1rem + 2vw,2.4rem);margin:0 0 22px;display:inline-flex;align-items:center;gap:12px;letter-spacing:.3px}
    h2 .bar{inline-size:10px;block-size:28px;border-radius:999px;background:linear-gradient(180deg,var(--accent),var(--accent-2));box-shadow:0 6px 18px rgba(255,85,85,.35)}
    p{color:var(--muted)}

    /* ===== Scrollers cartes ===== */
    .scroll-card{display:grid;grid-auto-flow:column;grid-auto-columns:var(--card-w);gap:18px;overflow-x:auto;padding:6px 2px 14px;scroll-snap-type:x mandatory;scroll-padding-inline:var(--space);-webkit-overflow-scrolling:touch;overscroll-behavior-x:contain}
    .scroll-card{scrollbar-width:none}.scroll-card::-webkit-scrollbar{display:none}
    .mini-card{position:relative;background:linear-gradient(180deg,var(--card),#111);border-radius:var(--radius);overflow:clip;scroll-snap-align:start;outline:none;border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow-md);transition:transform .28s ease, box-shadow .28s ease, border-color .28s ease;cursor:pointer}
    @media (hover:hover) and (pointer:fine){.mini-card:hover{transform:translateY(-6px) scale(1.01);box-shadow:0 20px 40px rgba(255,85,85,.25);border-color:rgba(255,85,85,.35)}}
    .mini-card__img{width:100%;aspect-ratio:16/10;object-fit:cover;background:#0f0f0f}
    .mini-card__body{padding:12px 14px 16px}
    .mini-card__title{font-size:clamp(1rem,.9rem + .5vw,1.15rem);margin:6px 0 6px}
    .mini-card__text{margin:0;font-size:.98rem;line-height:1.7}
    .mini-card__day{position:absolute;top:8px;left:8px;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);box-shadow:0 6px 14px rgba(0,0,0,.35);font-size:.82rem;line-height:1;backdrop-filter:blur(4px)}

    /* ===== Backdrop modal ===== */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,0);opacity:0;pointer-events:none;transition:opacity .35s ease;z-index:999}
    .backdrop.is-open{opacity:1;background:rgba(0,0,0,.6);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}

    /* ===== Wrappers maps ===== */
    .map-shell{
      position:relative;
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow-md);
      border:1px solid rgba(255,255,255,.08);
      background:#0f0f0f;
      contain:paint;
      isolation:isolate;
    }
    .is-safari-clip .map-shell{
      overflow:visible;
      clip-path: inset(0 round var(--radius));
      border:none;
      box-shadow:var(--shadow-md);
    }

    #travel-map, #route-map{
      height:clamp(420px,62vh,720px);
      width:100%;
      transform:translateZ(0);
      backface-visibility:hidden;
      will-change:transform;
      border-radius:0;
    }
    .map-shell--route #route-map{height:clamp(260px,46vh,560px)}

    .panel{margin-block:14px 0 0;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:#151515;cursor:pointer}

    .emoji-pin{position:relative;display:grid;place-items:center;width:38px;height:38px;border-radius:999px;background:radial-gradient(circle at 30% 30%,#2a2a2a,#141414);border:2px solid rgba(255,255,255,.2);box-shadow:0 6px 16px rgba(0,0,0,.5),0 0 0 2px rgba(255,85,85,.15);font-size:18px;color:#fff;cursor:pointer}

    /* ===== V√©hicules (route) ===== */
    .route-vehicle{width:34px;height:34px;transform-origin:50% 50%;transition:transform 120ms ease, opacity 280ms ease;pointer-events:none;filter:drop-shadow(0 0 10px rgba(255,85,85,.65));opacity:1}
    .route-vehicle.is-hidden{opacity:0;transform:scale(.85) rotate(var(--keep-rot,0deg))}
    .route-vehicle svg{width:100%;height:100%;display:block}
    .is-safari .route-vehicle{ filter:none; }

    /* ===== Progression itin√©raire (barre sous la map) ===== */
    .route-progress{margin-top:12px}
    .route-progress__head{display:flex;justify-content:space-between;align-items:center;font-size:.92rem;color:var(--muted);margin:8px 2px}
    .route-progress__track{position:relative;height:12px;background:#111;border:1px solid rgba(255,255,255,.12);border-radius:999px;overflow:hidden;box-shadow:inset 0 4px 12px rgba(0,0,0,.35)}
    .route-progress__fill{position:absolute;inset:0 auto 0 0;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:inset 0 0 20px rgba(255,85,85,.35);border-radius:999px}
    .route-progress__stops{position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);pointer-events:none}
    .route-progress__stops .stop{position:absolute;left:var(--pos);transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:8px;white-space:nowrap}
    .route-progress__stops .stop i{display:block;width:12px;height:12px;border-radius:999px;background:#0f0f0f;border:2px solid rgba(255,255,255,.6);box-shadow:0 1px 6px rgba(0,0,0,.4)}
    .route-progress__stops .stop em{display:block;font-style:normal;margin-top:8px;font-size:.8rem;color:var(--muted);text-shadow:0 1px 1px rgba(0,0,0,.35)}
    .route-progress__stops .stop.is-passed i{background:var(--accent);border-color:var(--accent)}
    .route-progress__stops .stop.is-active i{background:var(--accent-2);border-color:var(--accent-2);box-shadow:0 0 0 4px rgba(255,85,85,.15), 0 0 12px rgba(255,85,85,.45)}
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin>
</head>
<body>

  <div class="backdrop" id="backdrop" aria-hidden="true"></div>

  <!-- =================== ROUTE (train + avions) =================== -->
  <section id="route" class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span>Le trac√© de mon voyage</h2>

      <div class="map-shell map-shell--route">
        <div id="route-map" role="region" aria-label="Carte du trac√© du voyage"></div>
      </div>

      <div class="route-progress" id="route-progress" aria-label="Progression du trajet">
        <div class="route-progress__head">
          <span>Le trac√© de mon voyage</span>
          <span id="route-progress-time">00:00 / 00:15</span>
        </div>
        <div class="route-progress__track">
          <div class="route-progress__fill" id="route-progress-fill" style="width:0%"></div>
          <div class="route-progress__stops" id="route-progress-stops">
            <span class="stop is-active" style="--pos:0%"><i></i><em>Cherbourg</em></span>
            <span class="stop" style="--pos:26.6667%"><i></i><em>Paris</em></span>
            <span class="stop" style="--pos:76%"><i></i><em>P√©kin</em></span>
            <span class="stop" style="--pos:100%"><i></i><em>Tokyo</em></span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- =================== Carte activit√©s (Leaflet) =================== -->
  <section id="map" class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Carte des activit√©s</h2>
      <div class="map-shell">
        <div id="travel-map" role="region" aria-label="Carte interactive du Japon"></div>
      </div>

      <div class="panel" aria-label="Filtres">
        <div class="filters" id="filters">
          <label class="chip"><input type="radio" name="mapcat" data-cat="city" checked> üèôÔ∏è Villes</label>
          <label class="chip"><input type="radio" name="mapcat" data-cat="monument"> üèõÔ∏è Monuments</label>
          <label class="chip"><input type="radio" name="mapcat" data-cat="activity"> üéå Activit√©s</label>
        </div>
      </div>

      <!-- Marqueurs JSON inline -->
      <script id="markers-data" type="application/json">
      {
        "items": [
          { "lat": 35.6595, "lng": 139.7005, "category": "city",    "emoji": "üèôÔ∏è", "title": "Jour 1 ‚Äì Tokyo",            "desc": "Rien √† l‚Äôheure actuelle", "slug": "jour-1-tokyo" },
          { "lat": 35.7148, "lng": 139.7967, "category": "temple",  "emoji": "‚õ©Ô∏è", "title": "Jour 2 ‚Äì Asakusa",          "desc": "Rien √† l‚Äôheure actuelle", "slug": "jour-2-asakusa" },
          { "lat": 34.9671, "lng": 135.7727, "category": "temple",  "emoji": "‚õ©Ô∏è", "title": "Jour 3 ‚Äì Fushimi Inari",    "desc": "Rien √† l‚Äôheure actuelle", "slug": "jour-3-fushimi-inari" },
          { "lat": 35.0116, "lng": 135.7681, "category": "activity","emoji": "üéå", "title": "Jour 4 ‚Äì C√©r√©monie du th√©", "desc": "Rien √† l‚Äôheure actuelle", "slug": "jour-4-ceremonie-the" },
          { "lat": 35.6895, "lng": 139.6917, "category": "feeling", "emoji": "üí≠", "title": "Jour 5 ‚Äì Choc culturel",     "desc": "Rien √† l‚Äôheure actuelle", "slug": "jour-5-choc-culturel" },
          { "lat": 35.6762, "lng": 139.6503, "category": "sport",   "emoji": "üèÉ", "title": "Jour 6 ‚Äì Marche √† Tokyo",    "desc": "Rien √† l‚Äôheure actuelle", "slug": "jour-6-marche-tokyo" },
          { "lat": 35.0394, "lng": 135.7292, "category": "book",    "emoji": "üìö", "title": "Jour 7 ‚Äì L‚ÄôIdiot ‚Äî F. Dosto√Øevski", "desc": "R√©sum√© : ...", "slug": "jour-7-l-idiot" }
        ]
      }
      </script>

      <!-- Programme du jour JSON inline -->
      <script id="daylog-data" type="application/json">
      {
        "days": [
          { "date": "2025-10-30", "place": "Kyoto ‚Äî Gion", "done": ["Balade au quartier traditionnel", "Gy√¥za au march√© de Nishiki"] },
          { "date": "2025-10-31", "place": "Shibuya, Tokyo", "done": ["Passage √† Shibuya Crossing", "Lecture : L'Idiot (2 chapitres)"] }
        ]
      }
      </script>

      <!-- O√π suis-je -->
      <div class="nowinfo" id="nowinfo">
        <div class="nowinfo__card" style="background:linear-gradient(180deg, var(--card), #121212); border:1px solid rgba(255,255,255,.10); border-radius:var(--radius); padding:14px 16px; box-shadow:var(--shadow-md);">
          <div class="nowinfo__title" style="font-weight:700; letter-spacing:.2px; margin-bottom:10px; font-size:1.05rem;">Programme du jour (<span class="nowinfo__date" id="nowinfo-date">‚Äî</span>)</div>
          <div class="nowinfo__row" style="display:flex; gap:10px; align-items:baseline; margin-top:4px;">
            <span class="nowinfo__label" style="color:var(--muted); font-size:.92rem; min-width:110px;">Lieu :</span>
            <span id="nowinfo-place">‚Äî</span>
          </div>
          <div class="nowinfo__row" style="display:flex; gap:10px; align-items:baseline; margin-top:4px;">
            <span class="nowinfo__label" style="color:var(--muted); font-size:.92rem; min-width:110px;">Ce que j'ai fait :</span>
            <ul class="nowinfo__list" id="nowinfo-done" style="margin:0; padding-left:1.1rem; color:var(--muted)"><li>‚Äî</li></ul>
          </div>
          <div class="nowinfo__row" style="display:flex; gap:10px; align-items:baseline; margin-top:10px;">
            <span class="nowinfo__label" style="color:var(--muted); font-size:.92rem; min-width:110px;">Historique :</span>
            <div id="nowinfo-history" aria-live="polite">‚Äî</div>
          </div>
        </div>
      </div>
      <!-- /O√π suis-je -->
    </div>
  </section>

  <!-- =================== Sections cartes =================== -->
  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Villes visit√©es</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Villes">
        <article class="mini-card" data-slug="jour-1-tokyo" data-day="Jour 1" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/tokyo.png" alt="Tokyo ‚Äì Shibuya" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Monuments vus</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Monuments">
        <article class="mini-card" data-slug="jour-3-fushimi-inari" data-day="Jour 1" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/fushimi.jpg" alt="Fushimi Inari" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Activit√©s faites</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Activit√©s">
        <article class="mini-card" data-slug="jour-4-ceremonie-the" data-day="Jour 1" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/ceremonie.jpg" alt="C√©r√©monie du th√©" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Ressenti / √âmotion</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Ressenti">
        <article class="mini-card" data-slug="jour-5-choc-culturel" data-day="Jour 1" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/ressenti.jpg" alt="Rue calme" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Edit</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì √âdits vid√©o">
        <article class="mini-card" data-slug="jour-6-marche-tokyo" role="button" tabindex="0" aria-label="Carte ‚Äì ouvrir" data-title="Rien √† l'heure actuelle" data-text="Rien √† l'heure actuelle">
          <img class="mini-card__img" src="images/marche.jpg" alt="Marche" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">Rien √† l'heure actuelle</h3>
            <p class="mini-card__text">Rien √† l'heure actuelle</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <section class="section">
    <div class="wrap">
      <h2><span class="bar" aria-hidden="true"></span> Livre lu</h2>
      <div class="scroll-card" role="list" aria-label="Aper√ßus cartes ‚Äì Livres">
        <article
          class="mini-card"
          data-slug="jour-7-l-idiot"
          role="button"
          tabindex="0"
          aria-label="Carte ‚Äì ouvrir"
          data-title="L'Idiot ‚Äî F. Dosto√Øevski (1869)"
          data-text="La bont√© peut-elle survivre ?"
          data-longtext="R√©sum√© : ...">
          <img class="mini-card__img" src="images/lidiot.jpg" alt="¬´ L'Idiot ¬ª de Fiodor Dosto√Øevski" loading="lazy" />
          <div class="mini-card__body">
            <h3 class="mini-card__title">L'Idiot ‚Äî F. Dosto√Øevski (1869)</h3>
            <p class="mini-card__text">La bont√© peut-elle survivre ?</p>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- =================== Leaflet =================== -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin></script>
  <script>
    /* ===== Carte activit√©s (Japon) ===== */
    const map = L.map('travel-map', { zoomControl: true }).setView([36.2048, 138.2529], 5);

    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '¬© OpenStreetMap contributors',
      crossOrigin: true
    }).addTo(map);

    // Fallback tuile si OSM renvoie une tuile cass√©e -> dark Carto
    const FALLBACK_TMPL = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
    osm.on('tileerror', (e) => {
      const dpr = window.devicePixelRatio > 1 ? '@2x' : '';
      const url = FALLBACK_TMPL
        .replace('{s}', 'a')
        .replace('{z}', e.coords.z)
        .replace('{x}', e.coords.x)
        .replace('{y}', e.coords.y)
        .replace('{r}', dpr);
      e.tile.src = url;
    });

    // Pane d√©di√© aux emoji
    const emojiPane = map.createPane('emojiPane');
    emojiPane.style.zIndex = 650;

    const CATS = {
      city: { label:'Villes', emoji:'üèôÔ∏è' }, monument:{ label:'Monuments', emoji:'üèõÔ∏è' },
      activity:{ label:'Activit√©s', emoji:'üéå' }, feeling:{ label:'Ressenti', emoji:'üí≠' }, book:{ label:'Livres', emoji:'üìö' }
    };
    const VISIBLE_CATS = ['city','monument','activity'];
    const categoryLayers = Object.fromEntries(VISIBLE_CATS.map(k => [k, L.layerGroup().addTo(map)]));

    function emojiIcon(emoji='üìç'){
      return L.divIcon({
        className: 'emoji-icon',
        html: `<div class="emoji-pin" aria-hidden="true">${emoji}</div>`,
        iconSize: [38, 44], iconAnchor: [19, 40], popupAnchor: [0, -32]
      });
    }
    function openCardBySlug(slug) {
      if (!slug) return;
      const card = document.querySelector(`.mini-card[data-slug="${slug}"]`);
      if (!card) return;
      const scroller = card.closest('.scroll-card');
      if (scroller) card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      else card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => flyCard(card), 250);
    }
    function getMarkersData(){
      const inlineEl = document.getElementById('markers-data');
      if (inlineEl && inlineEl.textContent.trim()) {
        try { return Promise.resolve(JSON.parse(inlineEl.textContent)); }
        catch (e) { console.warn('[markers] JSON inline invalide', e); }
      }
      return Promise.resolve({ items: [] });
    }

    getMarkersData().then(loadFrom);
    function loadFrom(json){
      const items = (json && Array.isArray(json.items)) ? json.items : [];
      items.forEach((it) => {
        if (typeof it.lat !== 'number' || typeof it.lng !== 'number') return;
        const rawCat = it.category || 'city';
        const cat = (rawCat === 'temple') ? 'monument' : rawCat;
        const marker = L.marker([it.lat, it.lng], {
          icon: emojiIcon(it.emoji || (CATS[cat]?.emoji) || 'üìç'),
          pane: 'emojiPane'
        });
        const popup = renderPopup(it, cat);
        marker.bindPopup(popup, { closeButton: true });
        if (categoryLayers[cat]) categoryLayers[cat].addLayer(marker);
      });
      if (items.length) fitToMarkers();
    }
    function renderPopup(it, cat){
      const wrap = document.createElement('div');
      const t = (it.title || "Rien √† l'heure actuelle");
      const d = (it.desc  || "Rien √† l'heure actuelle");
      const slug = it.slug;

      wrap.innerHTML = `
        <strong style="display:block;margin-bottom:4px">${(it.emoji||'üìç')} ${escapeHtml(t)}</strong>
        ${it.day ? `<div style="color:#bbb;">${escapeHtml(it.day)}</div>` : ''}
        <div style="color:#ccc;white-space:pre-wrap">${escapeHtml(d)}</div>
        <div style="margin-top:8px;font-size:.85rem;color:#bbb">Cat√©gorie : ${CATS[it.category]?.emoji || ''} ${CATS[it.category]?.label || it.category || cat}</div>
        ${slug ? `<div style="margin-top:10px"><button type="button" class="goto-card" style="border:1px solid rgba(255,255,255,.14);background:#222;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer">Voir la carte ‚Üí</button></div>` : ''}
      `;
      if (slug) {
        wrap.querySelector('.goto-card').addEventListener('click', () => {
          map.closePopup();
          openCardBySlug(slug);
        });
      }
      return wrap;
    }
    function escapeHtml(str=''){ return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }
    function fitToMarkers(){
      const b=L.latLngBounds([]);
      for (const g of Object.values(categoryLayers)) g.eachLayer(m=>{ if(m.getLatLng) b.extend(m.getLatLng()); });
      if (b.isValid()) map.fitBounds(b.pad(0.2));
    }

    // Filtres
    document.querySelectorAll('#filters input[type="radio"]').forEach(rb => {
      const cat = rb.dataset.cat;
      rb.addEventListener('change', () => {
        if (!rb.checked) return;
        Object.values(categoryLayers).forEach(g => { try { map.removeLayer(g); } catch(e){} });
        const group = categoryLayers[cat];
        if (group) map.addLayer(group);
      });
    });
    (function(){
      const selected = document.querySelector('#filters input[type="radio"]:checked');
      if (!selected) return;
      Object.values(categoryLayers).forEach(g => { try { map.removeLayer(g); } catch(e){} });
      const group = categoryLayers[selected.dataset.cat];
      if (group) map.addLayer(group);
    })();

    /* ===== O√π suis-je ===== */
    const CURRENT_PLACE = 'Shibuya, Tokyo';
    const CURRENT_DONE = [];
    function getDayLogData(){
      const inlineEl = document.getElementById('daylog-data');
      if (inlineEl && inlineEl.textContent.trim()) {
        try { return Promise.resolve(JSON.parse(inlineEl.textContent)); }
        catch(e){ console.warn('[daylog] JSON inline invalide', e); }
      }
      return Promise.resolve({ days: [] });
    }
    function formatFRDateISO(iso){
      try { return new Intl.DateTimeFormat('fr-FR', { weekday:'long', day:'2-digit', month:'long', year:'numeric', timeZone: 'Europe/Paris' }).format(new Date(iso+'T00:00:00')); } catch(e){ return iso; }
    }
    (function fillNowInfo(){
      const placeEl = document.getElementById('nowinfo-place');
      const doneEl  = document.getElementById('nowinfo-done');
      const histEl  = document.getElementById('nowinfo-history');

      getDayLogData().then(data => {
        const days = Array.isArray(data?.days) ? [...data.days] : [];
        days.sort((a,b)=> String(b.date).localeCompare(String(a.date)) );

        const todayISO = new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Paris' });
        const todayEntry = days.find(d => d.date === todayISO);

        const place = todayEntry?.place ?? CURRENT_PLACE;
        const done  = todayEntry?.done ?? (Array.isArray(CURRENT_DONE) ? CURRENT_DONE : []);

        if (placeEl) placeEl.textContent = place || '‚Äî';
        if (doneEl) {
          if (done.length) {
            doneEl.innerHTML = '';
            done.forEach(txt => { const li = document.createElement('li'); li.textContent = txt; doneEl.appendChild(li); });
          } else {
            doneEl.innerHTML = '<li>‚Äî</li>';
          }
        }

        if (histEl) {
          const previous = days.filter(d => String(d.date) < todayISO);
          if (previous.length) {
            const wrap = document.createElement('div'); wrap.className = 'history';
            previous.forEach(d => {
              const item = document.createElement('div');
              item.className = 'history__item';
              item.style.cssText = 'padding:8px 10px;border-radius:10px;background:#121212;border:1px solid rgba(255,255,255,.08);margin:6px 0;';
              item.innerHTML = `
                <div class="history__date" style="font-weight:600;font-size:.92rem">${formatFRDateISO(d.date)}</div>
                ${d.place ? `<div class="history__place" style="color:var(--muted)">${d.place}</div>` : ''}
              `;
              if (Array.isArray(d.done) && d.done.length) {
                const ul = document.createElement('ul'); ul.className = 'history__list'; ul.style.cssText='margin:4px 0 0;padding-left:1.1rem;color:var(--muted)';
                d.done.forEach(t => { const li = document.createElement('li'); li.textContent = t; ul.appendChild(li); });
                item.appendChild(ul);
              }
              wrap.appendChild(item);
            });
            histEl.innerHTML = '';
            histEl.appendChild(wrap);
          } else {
            histEl.textContent = '‚Äî';
          }
        }
      });
    })();
    (function showToday(){
      const el = document.getElementById('nowinfo-date');
      if (!el) return;
      const opts = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' };
      el.textContent = new Intl.DateTimeFormat('fr-FR', opts).format(new Date());
    })();

    /* ===== Fallback d‚Äôimages locales ===== */
    (function fallbackLocalImages(){
      const ph = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 100'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#1b1b1b'/><stop offset='1' stop-color='#111111'/></linearGradient></defs><rect width='160' height='100' fill='url(#g)'/><g fill='#ff5555' opacity='0.85'><circle cx='24' cy='24' r='6'/><circle cx='48' cy='24' r='6'/><circle cx='72' cy='24' r='6'/></g><text x='50%' y='56%' dominant-baseline='middle' text-anchor='middle' font-family='-apple-system,Segoe UI,Roboto,Arial' font-size='10' fill='#b7b7b7'>aper√ßu indisponible</text></svg>`);
      const PLACEHOLDER = `data:image/svg+xml;charset=utf-8,${ph}`;
      const imgs = document.querySelectorAll('img.mini-card__img');
      imgs.forEach(img => {
        img.addEventListener('error', () => {
          if (!img.dataset.fallbackApplied) {
            img.src = PLACEHOLDER;
            img.dataset.fallbackApplied = '1';
          }
        }, { once: true });
      });
      if (location.protocol === 'file:') {
        const allowList = new Set(['images/tokyo.png','images/lidiot.jpg']);
        imgs.forEach(img => {
          const src = img.getAttribute('src') || '';
          if (!allowList.has(src)) {
            img.setAttribute('src', PLACEHOLDER);
            img.dataset.fallbackApplied = '1';
          }
        });
      }
    })();
  </script>

  <!-- =================== Fly Card (modal anim√©e) =================== -->
  <script>
    const FOCUSABLE = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
    const backdrop = document.getElementById('backdrop');
    let openClone = null, originRect = null, lastFocusedEl = null;

    document.addEventListener('click', (e) => {
      const card = e.target.closest('.mini-card');
      if (!card) return;
      e.preventDefault();
      flyCard(card);
    });
    document.addEventListener('keydown', (e) => {
      const card = e.target.closest?.('.mini-card');
      if (card && (e.key === 'Enter' || e.key === ' ')) { e.preventDefault(); flyCard(card); }
      if (e.key === 'Escape' && openClone) closeFly();
    });
    (function attachDayBadges(){
      document.querySelectorAll('.mini-card').forEach(card => {
        const day = card.dataset.day;
        if (!day) return;
        if (card.querySelector('.mini-card__day')) return;
        const badge = document.createElement('div');
        badge.className = 'mini-card__day';
        badge.textContent = day;
        card.appendChild(badge);
      });
    })();
    backdrop.addEventListener('click', () => { if (openClone) closeFly(); });

    function flyCard(card){
      if (openClone) return;
      lastFocusedEl = document.activeElement;
      originRect = card.getBoundingClientRect();

      const clone = document.createElement('div');
      clone.className = 'card-clone';
      setRect(clone.style, originRect);

      const media = card.querySelector('img').cloneNode();
      media.className = 'clone-media';
      media.removeAttribute('loading');

      const content = document.createElement('div');
      content.className = 'clone-content';

      const title = document.createElement('h3');
      title.textContent = card.dataset.title || card.querySelector('.mini-card__title')?.textContent || "Rien √† l'heure actuelle";

      const day = card.dataset.day;
      let dayLine;
      if (day) {
        dayLine = document.createElement('div');
        dayLine.textContent = day;
        dayLine.style.cssText = 'font-size:.9rem;opacity:.85;margin-top:-2px;margin-bottom:8px';
      }

      const text = document.createElement('p');
      text.textContent = card.dataset.longtext || card.dataset.text || card.querySelector('.mini-card__text')?.textContent || "Rien √† l'heure actuelle";
      text.style.color = 'var(--muted)';
      text.style.whiteSpace = 'pre-wrap';

      if (dayLine) content.append(title, dayLine, text); else content.append(title, text);

      const close = document.createElement('button');
      close.className = 'close-btn';
      close.type = 'button';
      close.setAttribute('aria-label','Fermer la carte');
      close.innerHTML = '<span aria-hidden="true">‚úï</span><span class="sr-only">Fermer</span>';
      close.addEventListener('click', closeFly);

      clone.append(media, close, content);
      document.body.appendChild(clone);

      clone.style.opacity = '0';
      clone.style.transform = 'translate(0, 0) scale(0.98)';

      requestAnimationFrame(() => {
        const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        backdrop.classList.add('is-open');
        backdrop.setAttribute('aria-hidden','false');
        document.documentElement.style.overflow = 'hidden';

        const DURATION = 520;
        const EASE = 'cubic-bezier(0.22, 0.61, 0.36, 1)';

        const target = targetRect();
        if (!reduced) {
          clone.style.transition = `
            top ${DURATION}ms ${EASE},
            left ${DURATION}ms ${EASE},
            width ${DURATION}ms ${EASE},
            height ${DURATION}ms ${EASE},
            transform ${DURATION}ms ${EASE},
            opacity 360ms ease-out,
            box-shadow ${DURATION}ms ${EASE}
          `;
        }

        applyRect(clone.style, target);
        clone.style.transform = 'translate(-50%, -50%) scale(1)';
        clone.style.opacity = '1';
        clone.style.boxShadow = '0 24px 60px rgba(0,0,0,.55)';

        setTimeout(() => (clone.querySelector(FOCUSABLE) || close).focus({preventScroll:true}), reduced?0:240);
      });
      openClone = clone;
      document.addEventListener('focus', trapFocus, true);
    }
    function closeFly(){
      if (!openClone) return;
      const clone = openClone; const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const DURATION = 480;
      const EASE = 'cubic-bezier(0.22, 0.61, 0.36, 1)';
      if (!reduced) {
        clone.style.transition = `
          top ${DURATION}ms ${EASE},
          left ${DURATION}ms ${EASE},
          width ${DURATION}ms ${EASE},
          height ${DURATION}ms ${EASE},
          transform ${DURATION}ms ${EASE},
          opacity 300ms ease-in,
          box-shadow ${DURATION}ms ${EASE}
        `;
      }
      setRect(clone.style, originRect);
      clone.style.transform = 'translate(0,0) scale(0.985)';
      clone.style.opacity = '0';
      clone.style.boxShadow = '0 16px 40px rgba(0,0,0,.40)';
      backdrop.classList.remove('is-open'); backdrop.setAttribute('aria-hidden','true');
      setTimeout(()=>{ clone.remove(); openClone=null; document.documentElement.style.overflow=''; document.removeEventListener('focus', trapFocus, true); if (lastFocusedEl?.focus) lastFocusedEl.focus({preventScroll:true}); }, reduced?0:480);
    }
    function trapFocus(e){ if (openClone && !openClone.contains(e.target)){ e.stopPropagation(); (openClone.querySelector(FOCUSABLE)||openClone).focus(); } }
    function setRect(s, r){ s.top=r.top+'px'; s.left=r.left+'px'; s.width=r.width+'px'; s.height=r.height+'px'; }
    function applyRect(s, r){ s.top=r.top; s.left=r.left; s.width=r.width+'px'; s.height=r.height+'px'; }
    function targetRect(){ const w=Math.min(900, innerWidth*0.9), h=Math.min(900, innerHeight*0.85); return { top:'50%', left:'50%', width:w, height:h }; }
  </script>

<!-- =================== Google Maps : route anim√©e (smooth + progress bar + zoom final Japon) =================== -->
<script>
  /* Timeline totale: 15s
     0: Cherbourg ‚Üí Paris (train) 4.0 s
     1: Pause Paris               0.4 s
     2: Paris ‚Üí P√©kin  (avion)    7.0 s
     3: P√©kin ‚Üí Tokyo  (avion)    3.6 s
  */
  const CUSTOM_ROUTE = [
    { name:'Cherbourg-en-Cotentin', lat:49.639,  lng:-1.623,  mode:'train' },
    { name:'Paris',                  lat:48.8566, lng:  2.3522, mode:'plane' },
    { name:'P√©kin',                  lat:39.9042, lng:116.4074, mode:'plane' },
    { name:'Tokyo',                  lat:35.6895, lng:139.6917, mode:'arrival' }
  ];
  const TOTAL_DURATION = 15000;
  const TL_FRAC = [0.2666667, 0.0266667, 0.4666667, 0.2400000]; // somme = 1

  // Easing / Utils
  const easeOutCubic   = t => 1 - Math.pow(1 - t, 3);
  const easeInOutCubic = t => (t < .5) ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
  const clamp01 = v => Math.max(0, Math.min(1, v));
  const lerp = (a,b,t)=> a + (b-a)*t;
  const damp = (cur, target, lambda, dt) => cur + (target - cur) * (1 - Math.exp(-lambda * dt));
  const dampAngle = (cur, target, lambda, dt) => {
    let diff = ((target - cur + 180) % 360 + 360) % 360 - 180;
    return cur + diff * (1 - Math.exp(-lambda * dt));
  };
  const fmtTime = (ms)=> {
    const s = Math.round(ms/1000);
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    return `${mm}:${ss}`;
  };

  // Zooms
  const Z_START  = 6.0;
  const Z_TRAIN  = 9.6;
  const Z_FLIGHT = 3.5;
  const Z_JAPAN  = 6.4; // üîé zoom pays (archipel)

  // Flag anti-double init
  window.__routeMapInitDone = false;

  async function __doInitRouteMap(){
    if (window.__routeMapInitDone) return;
    window.__routeMapInitDone = true;

    const { Map, Polyline } = await google.maps.importLibrary('maps');
    const { AdvancedMarkerElement } = await google.maps.importLibrary('marker');
    await google.maps.importLibrary('geometry');

    const el = document.getElementById('route-map');
    const START_CENTER = { lat: 47.5, lng: 5 };

    const gmap = new Map(el, {
      mapId: 'f60c984af47f9eb0883d6725',
      center: START_CENTER,
      zoom: Z_START,
      gestureHandling: 'greedy',
      backgroundColor: '#0f0f0f',
      mapTypeControl: false,
      fullscreenControl: false,
      streetViewControl: false,
      zoomControl: true
    });

    const coords = CUSTOM_ROUTE.map(s => ({ lat: s.lat, lng: s.lng }));

    // Ligne guide anim√©e + glow + ligne de progression
    const dashSymbol = { path:'M 0,-1 0,1', strokeOpacity:0.5, strokeWeight:2, scale:3, strokeColor:'#ffffff' };
    const guide = new Polyline({ path: coords, geodesic:true, strokeOpacity:0, map:gmap, icons:[{icon:dashSymbol, offset:'0', repeat:'16px'}], clickable:false });
    let guideAnimId = null, guideOffset = 0;
    const animateGuide = () => { guideOffset=(guideOffset+1)%32; guide.set('icons',[{icon:dashSymbol, offset:`${guideOffset}px`, repeat:'16px'}]); guideAnimId=requestAnimationFrame(animateGuide); };

    const glow = new Polyline({ path: coords, geodesic:true, strokeColor:'#ff6b6b', strokeOpacity:0.28, strokeWeight:10, map:gmap, clickable:false });
    const line = new Polyline({ path: [coords[0]], geodesic:true, strokeColor:'#ff5555', strokeOpacity:1, strokeWeight:4, map:gmap, clickable:false });

    // √âtapes num√©rot√©es
    coords.forEach((pos,i)=>{
      const div = document.createElement('div'); div.className='emoji-pin'; div.style.borderColor='rgba(255,255,255,.35)';
      div.innerHTML = `<strong style="font-size:14px">${i+1}</strong>`;
      new AdvancedMarkerElement({ map:gmap, position:pos, content:div, title:`√âtape ${i+1} ‚Äì ${CUSTOM_ROUTE[i].name}` });
    });

    // V√©hicules (train + avion)
    const trainEl = document.createElement('div');
    trainEl.className = 'route-vehicle';
    trainEl.innerHTML = `
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <defs><linearGradient id="gradTrain" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffffff"/><stop offset="1" stop-color="#cfe7ff"/></linearGradient></defs>
        <path d="M32 4c5 0 10 2 13 5 5 5 5 13 5 20v8c0 3-2 5-5 6l-4 1v6h4a2 2 0 110 4H19a2 2 0 110-4h4v-6l-4-1c-3-1-5-3-5-6v-8c0-7 0-15 5-20 3-3 8-5 13-5z" fill="url(#gradTrain)"/>
        <rect x="22" y="14" width="20" height="10" rx="2" fill="#1b6dff" opacity=".85"/>
        <rect x="20" y="28" width="24" height="8" rx="2" fill="#555"/>
        <circle cx="24" cy="52" r="3" fill="#444"/><circle cx="40" cy="52" r="3" fill="#444"/>
      </svg>`;
    const trainMarker = new google.maps.marker.AdvancedMarkerElement({ map:gmap, position:coords[0], content:trainEl, zIndex:1000 });

    const planeEl = document.createElement('div');
    planeEl.className = 'route-vehicle is-hidden';
    planeEl.innerHTML = `
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <defs><linearGradient id="gradPlane" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#ffffff"/><stop offset="1" stop-color="#ffb3b3"/></linearGradient></defs>
        <path d="M32 2c2.2 0 3.2 6.8 4.2 12.1l2.6 13.2 16.8 8.1c2.1 1 .9 3.6-1.3 3.2L39.7 36l1.7 12.2c.3 2-1.3 3.6-3.2 3L32 48l-6.2 3.2c-1.9 .6-3.5-1-3.2-3L24 36l-14.6 2.6c-2.2 .4-3.4-2.1-1.3-3.2l16.8-8.1 2.6-13.2C28.8 8.8 29.8 2 32 2z" fill="url(#gradPlane)"/>
        <rect x="28" y="20" width="8" height="10" rx="2" ry="2" fill="#ff5555" opacity="0.9"/>
      </svg>`;
    const planeMarker = new google.maps.marker.AdvancedMarkerElement({ map:gmap, position:coords[1], content:planeEl, zIndex:1000 });

    // Distances cumul√©es
    const segLen=[], cumLen=[0];
    for (let i=0;i<coords.length-1;i++){
      const a = new google.maps.LatLng(coords[i]);
      const b = new google.maps.LatLng(coords[i+1]);
      const d = google.maps.geometry.spherical.computeDistanceBetween(a,b);
      segLen.push(d); cumLen.push((cumLen[i]??0)+d);
    }
    function pathAtDistance(d){
      if (d<=0) return [coords[0]];
      const out=[coords[0]];
      let rem=d, i=0;
      while (i<segLen.length && rem>segLen[i]){ out.push(coords[i+1]); rem-=segLen[i]; i++; }
      if (i<segLen.length){
        const a = new google.maps.LatLng(coords[i]);
        const b = new google.maps.LatLng(coords[i+1]);
        const f = segLen[i] ? (rem/segLen[i]) : 0;
        const interp = google.maps.geometry.spherical.interpolate(a,b,f);
        out.push(interp);
      }
      return out;
    }

    // Cam√©ra amortie + orientation
    const cam = { lat: START_CENTER.lat, lng: START_CENTER.lng, zoom: Z_START };
    let heading = 0;
    function setVehiclePositionSmooth(markerEl, marker, from, to, dt){
      marker.position = to;
      const desired = google.maps.geometry.spherical.computeHeading(from, to);
      if (isFinite(desired)){
        heading = dampAngle(heading, desired, 8.0, dt);
        markerEl.style.transform = `rotate(${heading}deg)`;
        markerEl.style.setProperty('--keep-rot', `${heading}deg`);
      }
    }
    function showTrain(){ if (!trainMarker.map) trainMarker.map = gmap; trainEl.classList.remove('is-hidden'); }
    function hideTrain(){ trainEl.classList.add('is-hidden'); trainEl.addEventListener('transitionend',()=>{ trainMarker.map=null; }, { once:true }); }
    function showPlane(){ if (!planeMarker.map) planeMarker.map = gmap; planeEl.classList.remove('is-hidden'); }
    function hidePlane(){ planeEl.classList.add('is-hidden'); planeEl.addEventListener('transitionend',()=>{ planeMarker.map=null; }, { once:true }); }

    // ===== Progress bar DOM
    const STOP_POS = [0, TL_FRAC[0], TL_FRAC[0]+TL_FRAC[1]+TL_FRAC[2], 1];
    const fillEl = document.getElementById('route-progress-fill');
    const timeEl = document.getElementById('route-progress-time');
    const stopsEls = Array.from(document.querySelectorAll('#route-progress-stops .stop'));
    function activeStopIndex(p){ let idx=0; for (let i=0;i<STOP_POS.length;i++){ if (p+1e-6>=STOP_POS[i]) idx=i; } return idx; }
    function setProgress(global01, elapsedMs){
      const p = clamp01(global01);
      if (fillEl) fillEl.style.width = (p*100)+'%';
      if (timeEl) timeEl.textContent = `${fmtTime(elapsedMs)} / ${fmtTime(TOTAL_DURATION)}`;
      if (stopsEls.length){
        const a = activeStopIndex(p);
        stopsEls.forEach((el,i)=>{
          el.classList.toggle('is-passed', p >= STOP_POS[i]-1e-6);
          el.classList.toggle('is-active', i === a);
        });
      }
    }

    // üîé Zoom final sur le Japon (apr√®s l'arriv√©e)
    function focusOnJapan(center = { lat: 36.2048, lng: 138.2529 }, zoom = Z_JAPAN, ms = 2400){
      const startC = gmap.getCenter().toJSON();
      const startZ = gmap.getZoom() ?? cam.zoom ?? Z_START;
      const t0 = performance.now();

      const stepZoom = (now)=>{
        const t = Math.min(1, (now - t0) / ms);
        const e = easeInOutCubic(t);
        const cLat = lerp(startC.lat, center.lat, e);
        const cLng = lerp(startC.lng, center.lng, e);
        const z    = lerp(startZ, zoom, e);
        gmap.moveCamera({ center: { lat: cLat, lng: cLng }, zoom: z });
        if (t < 1) requestAnimationFrame(stepZoom);
      };
      requestAnimationFrame(stepZoom);
    }

    // Timeline
    const tDur = TL_FRAC.map(f => f * TOTAL_DURATION);
    const tCum = [0, tDur[0], tDur[0]+tDur[1], tDur[0]+tDur[2]+tDur[1], TOTAL_DURATION];
    let raf=null, currentTL=-1;

    function onTLChange(i){
      currentTL = i;
      if (i === 0){ showTrain(); hidePlane(); }
      else if (i === 1){ hideTrain(); showPlane(); planeMarker.position = coords[1]; }
      else { hideTrain(); showPlane(); }
    }

    function animateRoute(duration = TOTAL_DURATION){
      cancelAnimationFrame(raf);
      line.setPath([coords[0]]);
      heading = 0;

      planeEl.classList.add('is-hidden'); planeMarker.map=null;
      trainMarker.map=gmap; trainEl.classList.remove('is-hidden');

      // repart de l‚Äô√©tat r√©el de la cam√©ra
      const c0 = gmap.getCenter().toJSON();
      cam.lat = c0.lat; cam.lng = c0.lng; cam.zoom = gmap.getZoom() ?? Z_START;

      // reset UI
      setProgress(0, 0);

      const t0 = performance.now();
      let last = t0;

      const step = (now)=>{
        const elapsed = Math.min(now - t0, duration);
        const dt = Math.min((now - last)/1000, 0.05); last = now;

        // phase
        let tl = 0;
        if (elapsed >= tCum[3]) tl = 3;
        else if (elapsed >= tCum[2]) tl = 2;
        else if (elapsed >= tCum[1]) tl = 1;
        if (tl !== currentTL) onTLChange(tl);

        // progression locale
        const segStart = tCum[tl], segEnd = tCum[tl+1];
        const segT = (segEnd > segStart) ? (elapsed - segStart) / (segEnd - segStart) : 1;
        const pLocal = easeOutCubic(clamp01(segT));

        // distance parcourue
        let dist;
        if (tl === 0) dist = cumLen[0] + pLocal * segLen[0];
        else if (tl === 1) dist = cumLen[1];
        else if (tl === 2) dist = cumLen[1] + pLocal * segLen[1];
        else dist = cumLen[2] + pLocal * segLen[2];

        // mise √† jour du trac√©
        const subPath = pathAtDistance(dist);
        line.setPath(subPath);
        const cur = subPath[subPath.length-1];
        const prevLL = subPath.length > 1 ? subPath[subPath.length-2] : subPath[0];

        // v√©hicule
        if (tl === 0) setVehiclePositionSmooth(trainEl, trainMarker, prevLL, cur, dt);
        else          setVehiclePositionSmooth(planeEl,  planeMarker,  prevLL, cur, dt);

        // cible cam√©ra + zoom
        const centerTarget = (cur.lat && cur.lng)
          ? (typeof cur.lat === 'function' ? { lat: cur.lat(), lng: cur.lng() } : { lat: cur.lat, lng: cur.lng })
          : gmap.getCenter().toJSON();

        let desiredZ;
        if (tl === 0){
          const zt = easeInOutCubic(Math.min(segT * 1.1, 1));
          desiredZ = lerp(Z_START, Z_TRAIN, zt);
        } else if (tl === 1){
          desiredZ = lerp(Z_TRAIN, Z_FLIGHT, easeInOutCubic(segT));
        } else {
          desiredZ = Z_FLIGHT;
        }

        // amortisage (pas de saut de zoom)
        cam.lat  = damp(cam.lat,  centerTarget.lat,  6.0, dt);
        cam.lng  = damp(cam.lng,  centerTarget.lng,  6.0, dt);
        cam.zoom = damp(cam.zoom, desiredZ,         5.0, dt);

        gmap.moveCamera({ center: { lat: cam.lat, lng: cam.lng }, zoom: cam.zoom });

        // UI progression
        setProgress(elapsed / duration, elapsed);

        if (elapsed < duration){
          raf = requestAnimationFrame(step);
        } else {
          planeMarker.position = coords[coords.length-1];
          setProgress(1, duration);
          hidePlane();

          // üîé Zoom doux sur l'archipel japonais apr√®s l'arriv√©e
          focusOnJapan({ lat: 36.2048, lng: 138.2529 }, Z_JAPAN, 2400);
        }
      };
      raf = requestAnimationFrame(step);
    }

    animateGuide();
    animateRoute();
    document.getElementById('route-replay')?.addEventListener('click', ()=> animateRoute(TOTAL_DURATION));
    window.addEventListener('beforeunload', ()=>{ cancelAnimationFrame(guideAnimId); cancelAnimationFrame(raf); });
  }

  // Expose la callback demand√©e par le script Google
  window.initRouteMap = function initRouteMap(){ __doInitRouteMap().catch(console.error); };

  // Fallback au cas o√π le callback n'est pas appel√© (ordre de chargement)
  (function ensureGMapInit(){
    let tries = 0;
    const iv = setInterval(()=>{
      if (window.google && google.maps && typeof __doInitRouteMap === 'function'){
        clearInterval(iv); __doInitRouteMap().catch(()=>{});
      }
      if (++tries > 60) clearInterval(iv);
    }, 250);
  })();
</script>
<!-- Google Maps (async + defer + callback) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6dRG5nFFMMfX0rtZtYuYqOsTbKIgmR_g&v=weekly&libraries=marker,geometry&callback=initRouteMap&map_ids=f60c984af47f9eb0883d6725"></script>

</body>
</html>